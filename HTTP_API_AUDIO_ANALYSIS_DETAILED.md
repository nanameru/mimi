# HTTP API音声ガビガビ問題 コンソールログ分析レポート（詳細版）

## 調査日時
2025年1月5日

## コンソールログからの重要な発見

### 1. HTTP APIレスポンスヘッダーの確認

```
TTS Response Content-Type: audio/pcm
```

**重要な点**:
- ✅ HTTP APIは`audio/pcm`形式で返している
- ✅ `format: "pcm"`のリクエストが正しく処理されている

### 2. 最初のチャンクの先頭バイト

```
[FishAudioTTS] 🔍 First chunk preview (hex): fdfffdfffefffdff0000000000000000ffff0000ffffffffffff000000000000
[FishAudioTTS] 🔍 First chunk preview (decimal): 253, 255, 253, 255, 254, 255, 253, 255, 0, 0, 0, 0, 0, 0, 0, 0, 255, 255, 0, 0, 255, 255, 255, 255, 255, 255, 0, 0, 0, 0, 0, 0
[FishAudioTTS] 🔍 First chunk length: 813 bytes
[FishAudioTTS] ✓ First bytes suggest PCM format (FDFFFDFF)
```

**重要な点**:
- ✅ PCM形式として認識されている
- ✅ 先頭バイトは`fdff`（リトルエンディアンで-3）で始まっている
- ✅ MP3のマジックナンバー（`FF FB`など）ではない

### 3. 問題の可能性

**PCMデータの値が異常な可能性**:
- 先頭バイトが`fdfffdfffefffdff`となっており、連続した小さな負の値が続いている
- これは正常な音声データとは異なるパターンの可能性がある

**考えられる原因**:
1. **エンディアンの問題**: リトルエンディアンとして扱っているが、実際はビッグエンディアンで返されている可能性
2. **データのオフセット**: PCMデータにオフセットが加えられている可能性
3. **サンプルレートの不一致**: HTTP APIが返すサンプルレートが設定（44100Hz）と異なる可能性
4. **データの変換方法**: `Int16Array`への変換方法が間違っている可能性

## 追加のログで確認すべきポイント

1. **実際のPCMサンプル値**: 最初の10サンプルの値を確認
2. **リトルエンディアンとビッグエンディアンの違い**: どちらで解釈するのが正しいか
3. **サンプルの範囲**: データがクリッピングされていないか
4. **ゼロクロッシング**: 正常な音声データなら適度なゼロクロッシングがあるはず

## 次のステップ

追加したログで、以下の情報を確認できます：
- 最初の10サンプルの値
- リトルエンディアンとビッグエンディアンでの解釈の違い
- サンプルの範囲（クリッピングの検出）
- ゼロクロッシングの頻度（データの正常性の確認）

これらの情報から、音声がガビガビになる原因を特定できます。

