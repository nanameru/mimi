# Fish Audio データ形式分析結果

## 分析日時
2025年11月3日

## 分析対象ファイル
`debug-audio/fish-audio-2025-11-03T07-51-07-637Z-714chunks.bin` (12,740 bytes)

## 重要な発見

### 1. データ形式の判定結果

**❌ 正常なPCMデータではない**

- **サンプル範囲**: `-1` から `0` のみ（最初の10チャンク）
- **ユニークな値**: 2つだけ（-1と0）
- **ゼロサンプル**: 93.74%
- **-1サンプル**: 6.26%
- **エントロピー**: 0.44（正常なPCM: 7-8）

### 2. チャンクごとの分析

**最初の10チャンク**:
- すべて `range=[-1, 0]`, `absMax=1`
- これは正常な音声データではない

**ログからの情報（11-20チャンク）**:
- Chunk 11: `range=[-2, 1]`, `absMax=2`
- Chunk 12: `range=[-3, 1]`, `absMax=3`
- Chunk 19: `range=[-7027, 3363]`, `absMax=7027`
- Chunk 20: `range=[-7159, 4135]`, `absMax=7159`

**結論**: 最初の10チャンクは無音または極小の値で、後のチャンクから正常な音声データが始まっている

### 3. バイトパターン分析

**最初の32バイト**:
```
ffff ffff ffff ffff ffff ffff ffff 0000
0000 0000 ffff ffff 0000 0000 0000 0000
```

- `ffff` = `-1` (Int16, Little Endian)
- `0000` = `0` (Int16, Little Endian)
- パターンが極端に単純

**バイト頻度**:
- `0x00`: 910回（最初の1000バイト中）
- `0xFF`: 90回（最初の1000バイト中）
- 他のバイト値: ほとんど出現しない

### 4. データ形式の可能性

#### 可能性1: 最初のチャンクが無音/不完全
- Fish Audio APIが最初の数チャンクを無音で送信している
- または、ストリーミング開始時の不完全なデータ

#### 可能性2: データ形式の不一致
- `normalize: true`により、データが正規化されている可能性
- しかし、Int16として解釈すると`-1`と`0`しかない

#### 可能性3: 圧縮形式の誤解釈
- MP3やOpus形式のデータをPCMとして解釈している可能性
- しかし、マジックナンバーの確認ではMP3形式ではない

## 結論

### Fish Audioが返しているデータ形式

1. **実際の形式**: PCM形式（`Content-Type: audio/pcm`が正しい）
2. **データの特徴**:
   - 最初の10チャンク（約8KB）: 無音または極小の値（`-1`と`0`のみ）
   - 11チャンク目以降: 正常なPCMデータ（振幅が徐々に大きくなる）
3. **問題点**:
   - 最初のチャンクが無音のため、音声の開始部分が欠落している可能性
   - または、最初のチャンクをスキップする必要がある

### LiveKitが期待している形式

- **形式**: `Int16Array`形式の16-bit PCMデータ
- **振幅範囲**: `[-32768, 32767]`（未正規化）
- **エンディアン**: リトルエンディアン
- **サンプルレート**: 44100Hz
- **チャンネル数**: 1 (モノラル)

## 推奨される解決策

1. **最初の数チャンクをスキップ**: 無音部分を除外して処理
2. **振幅の確認**: 11チャンク目以降のデータは正常な範囲にあることを確認
3. **`normalize`設定の確認**: `normalize: true`がデータに与える影響を確認

## 次のステップ

1. 11チャンク目以降のデータを詳細に分析
2. `normalize: false`の場合のデータ形式を確認
3. 最初のチャンクをスキップする処理を実装

