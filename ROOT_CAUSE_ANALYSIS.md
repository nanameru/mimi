# 音声ガビガビ問題の根本原因分析

## 問題の本質

### ログから判明した事実

1. **最初の10チャンク**: `range=[-1, 0]` (無音データ)
2. **Chunk 11-20**: 振幅が徐々に大きくなる（-2 → 7159）
3. **Chunk 20以降**: 正常な振幅範囲（`absMax=7159`）

### 保存されたファイルから判明した事実

1. **すべてのチャンク**: `range=[-1, 0]` (無音データ)
2. **ログと不一致**: ログではChunk 19で`range=[-7159, 4135]`となっているが、実際のファイルでは`range=[-1, 0]`

## 根本原因の推測

### 仮説1: 最初のチャンクが無音で、これが「ガビガビ」の原因

**問題点**:
- 最初のチャンク（`-1`と`0`のみ）がそのままLiveKitに送信されている
- これが無音やノイズとして再生されている可能性

**しかし**:
- ログでは後のチャンクで正常な振幅が検出されている
- もし最初のチャンクだけが問題なら、後のチャンクは正常に聞こえるはず

### 仮説2: データ形式の不一致（最も可能性が高い）

**問題点**:
- `normalize: true`により、データが正規化されている可能性
- 正規化されたデータ（浮動小数点形式：-1.0 ～ 1.0）を`Int16Array`として解釈している
- しかし、`-1`と`0`しかないということは、正規化ではない

### 仮説3: エンディアンの問題

**問題点**:
- データがビッグエンディアンで返されている可能性
- しかし、ログでは`First sample (Little Endian): -2`となっており、リトルエンディアンが正しい

### 仮説4: 8ビットPCMが16ビットとして解釈されている

**問題点**:
- データが8ビットPCM（範囲: -128 ～ 127）として返されている
- しかし、`-1`と`0`しかないということは、これは8ビットPCMでもない

## 最も可能性が高い原因

### **最初のチャンクが無音データとして送信されている**

**根拠**:
1. ログでは、Chunk 11-20で振幅が徐々に大きくなっている
2. しかし、最初の10チャンクは`-1`と`0`のみ
3. これらのチャンクがそのままLiveKitに送信されている
4. これにより、音声の開始部分が欠落している

**解決策**:
- 振幅が一定の閾値（例: 100以上）になるまでチャンクをスキップ
- または、最初の数チャンク（例: 10チャンク）を自動的にスキップ

## 推奨される修正

1. **最初の無音チャンクをスキップ**: 振幅が閾値未満のチャンクをドロップ
2. **データ形式の確認**: `normalize: false`の場合のデータ形式を確認
3. **後続チャンクの詳細分析**: Chunk 20以降のデータが正常に処理されているか確認

