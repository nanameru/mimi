# HTTP API切り替え時の応答速度への影響 分析レポート

## 調査日時
2025年1月5日

## 現在の実装（WebSocket API）

### 動作フロー
1. **LLMがテキストをストリーミングで出力開始**
   - 最初のトークンが生成されるとすぐにTTSに送信される
   - 例: "こんにちは" → "は" → "！" → ... と順次送信

2. **TTSがテキストをバッファリング**
   - 50文字以上のテキストが集まると、WebSocket APIに送信
   - バッファリング中でも、フラッシュされると即座に送信

3. **WebSocket APIが音声を生成**
   - テキストを受信すると、すぐに音声生成を開始
   - チャンクごとに音声データを返す

4. **音声をLiveKitに送信**
   - 最初の音声チャンクが受信されると、すぐにLiveKitに送信
   - ストリーミングで音声を再生開始

### レイテンシーの例（ログから）
```
[FishAudioTTS] 📤 [3:56:55 PM] Sending buffered text (50 chars): "(excited)(happy) こんにちは！..."
[FishAudioTTS] ⏱️ First audio chunk received after 5450ms
```

**現在のレイテンシー**: 約5-6秒（テキスト送信から最初の音声チャンク受信まで）

## HTTP API切り替え後の実装

### 動作フロー
1. **LLMがテキストをストリーミングで出力開始**
   - 最初のトークンが生成されるとすぐにTTSに送信される
   - 例: "こんにちは" → "は" → "！" → ... と順次送信

2. **TTSがテキストを完全に受信**
   - **変更点**: すべてのテキストを受信するまで待機
   - `FLUSH_SENTINEL`が送られてくるまで、テキストをバッファリング

3. **HTTP APIで音声生成**
   - 完全なテキストを受信してから、HTTP APIに送信
   - HTTP APIはストリーミングレスポンスを返すが、音声生成は完全なテキストが必要

4. **音声をLiveKitに送信**
   - 最初の音声チャンクが受信されると、すぐにLiveKitに送信
   - ストリーミングで音声を再生開始

### レイテンシーの予測

#### 遅延の要因
1. **テキスト受信完了の待機時間**
   - LLMが完全にテキストを生成するまで待機
   - 例: 50文字のテキストが生成されるのに2-3秒かかる場合

2. **HTTP APIへの送信と処理開始**
   - HTTPリクエストの送信: 約50-100ms
   - サーバー側での音声生成開始: 約500-1000ms

3. **最初の音声チャンクの受信**
   - HTTP APIのストリーミングレスポンスで最初のチャンクを受信: 約2-3秒

#### 予測されるレイテンシー
**最悪の場合**: 10-15秒
- LLMのテキスト生成完了: 3-5秒
- HTTP APIへの送信と処理開始: 1秒
- 最初の音声チャンク受信: 5-8秒

**平均的な場合**: 8-12秒
- LLMのテキスト生成完了: 2-3秒
- HTTP APIへの送信と処理開始: 0.5秒
- 最初の音声チャンク受信: 4-6秒

**現在のWebSocket APIとの比較**: **約2-3倍遅くなる可能性**

## レイテンシーへの影響の詳細

### 1. テキスト生成の完了待機

**現在のWebSocket API**:
- LLMが最初の50文字を生成すると、すぐにTTSに送信
- TTSは部分的なテキストでも音声生成を開始できる
- **TTFT（Time To First Token）**: 約0.6秒（ログから）

**HTTP API**:
- LLMが完全にテキストを生成するまで待機
- 例: 50文字のテキストが生成されるのに約2-3秒かかる場合
- **追加レイテンシー**: 約2-3秒

### 2. 音声生成の開始タイミング

**現在のWebSocket API**:
- テキストを受信すると、すぐに音声生成を開始
- ストリーミングで音声を生成するため、低レイテンシー

**HTTP API**:
- 完全なテキストを受信してから、HTTPリクエストを送信
- HTTPリクエストの送信と処理開始に時間がかかる
- **追加レイテンシー**: 約0.5-1秒

### 3. 最初の音声チャンクの受信

**現在のWebSocket API**:
- WebSocket接続は維持されているため、即座に音声生成を開始
- **最初の音声チャンク受信**: 約5-6秒（ログから）

**HTTP API**:
- HTTPリクエストを送信してから、ストリーミングレスポンスを受信
- 接続の確立と処理開始に時間がかかる
- **最初の音声チャンク受信**: 約5-8秒（予測）

### 4. ストリーミングの効果

**現在のWebSocket API**:
- LLMがテキストを生成しながら、TTSも音声を生成
- パイプライン処理で、全体的なレイテンシーが低い

**HTTP API**:
- LLMがテキストを生成完了してから、TTSが音声生成を開始
- シーケンシャル処理で、全体的なレイテンシーが高い

## パフォーマンス比較

| 項目 | WebSocket API | HTTP API | 差分 |
|------|---------------|----------|------|
| **テキスト受信完了待機** | 不要（部分テキストで開始） | 必要（完全テキストまで待機） | +2-3秒 |
| **API接続確立** | 不要（接続維持） | 必要（リクエスト送信） | +0.5-1秒 |
| **最初の音声チャンク受信** | 約5-6秒 | 約5-8秒 | +0-2秒 |
| **総レイテンシー** | 約5-6秒 | 約8-12秒 | +3-6秒 |

## 改善策の検討

### 1. 部分的なテキストでHTTP APIを呼び出す（非推奨）
- エモーションタグの処理に影響する可能性
- エモーションタグが正しく処理されない可能性

### 2. テキスト生成の完了を待たずに、一定の文字数でHTTP APIを呼び出す
- 例: 50文字ごとにHTTP APIを呼び出す
- エモーションタグが途中で切れる可能性

### 3. エモーションタグを優先する（推奨）
- レイテンシーを犠牲にして、エモーションタグを正しく処理
- ユーザー体験を向上させる可能性

## 結論

### 応答速度への影響
**はい、HTTP APIに切り替えると、応答が遅くなります。**

- **現在のWebSocket API**: 約5-6秒で最初の音声が再生開始
- **HTTP API切り替え後**: 約8-12秒で最初の音声が再生開始
- **遅延の増加**: 約3-6秒

### 主な原因
1. **テキスト生成完了の待機**: +2-3秒
2. **HTTP API接続確立**: +0.5-1秒
3. **音声生成開始の遅延**: +0-2秒

### 推奨事項
- エモーションタグが正しく処理されることを優先する場合は、レイテンシーの増加を受け入れる
- レイテンシーを最優先する場合は、WebSocket APIを継続使用し、エモーションタグは使用しない
- 実際の動作確認を行い、許容できるレイテンシーかどうかを判断する

