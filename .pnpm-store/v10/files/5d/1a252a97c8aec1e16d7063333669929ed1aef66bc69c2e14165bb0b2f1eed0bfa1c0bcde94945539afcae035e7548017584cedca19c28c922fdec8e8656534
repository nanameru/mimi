{"version":3,"sources":["../src/http_server.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { type IncomingMessage, type Server, type ServerResponse, createServer } from 'node:http';\nimport { log } from './log.js';\n\nconst healthCheck = async (res: ServerResponse) => {\n  res.writeHead(200);\n  res.end('OK');\n};\n\ninterface WorkerResponse {\n  agent_name: string;\n  worker_type: string;\n  active_jobs: number;\n  sdk_version: string;\n  project_type: string;\n}\n\nexport class HTTPServer {\n  host: string;\n  port: number;\n  app: Server;\n  #logger = log();\n\n  constructor(host: string, port: number, workerListener: () => WorkerResponse) {\n    this.host = host;\n    this.port = port;\n\n    this.app = createServer((req: IncomingMessage, res: ServerResponse) => {\n      if (req.url === '/') {\n        healthCheck(res);\n      } else if (req.url === '/worker') {\n        res.writeHead(200, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify(workerListener()));\n      } else {\n        res.writeHead(404);\n        res.end('not found');\n      }\n    });\n  }\n\n  async run(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.app.listen(this.port, this.host, (err?: Error) => {\n        if (err) reject(err);\n        const address = this.app.address();\n        if (typeof address! !== 'string') {\n          this.#logger.info(`Server is listening on port ${address!.port}`);\n        }\n        resolve();\n      });\n    });\n  }\n\n  async close(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.app.close((err?: Error) => {\n        if (err) reject(err);\n        resolve();\n      });\n    });\n  }\n}\n"],"mappings":"AAGA,SAAiE,oBAAoB;AACrF,SAAS,WAAW;AAEpB,MAAM,cAAc,OAAO,QAAwB;AACjD,MAAI,UAAU,GAAG;AACjB,MAAI,IAAI,IAAI;AACd;AAUO,MAAM,WAAW;AAAA,EACtB;AAAA,EACA;AAAA,EACA;AAAA,EACA,UAAU,IAAI;AAAA,EAEd,YAAY,MAAc,MAAc,gBAAsC;AAC5E,SAAK,OAAO;AACZ,SAAK,OAAO;AAEZ,SAAK,MAAM,aAAa,CAAC,KAAsB,QAAwB;AACrE,UAAI,IAAI,QAAQ,KAAK;AACnB,oBAAY,GAAG;AAAA,MACjB,WAAW,IAAI,QAAQ,WAAW;AAChC,YAAI,UAAU,KAAK,EAAE,gBAAgB,mBAAmB,CAAC;AACzD,YAAI,IAAI,KAAK,UAAU,eAAe,CAAC,CAAC;AAAA,MAC1C,OAAO;AACL,YAAI,UAAU,GAAG;AACjB,YAAI,IAAI,WAAW;AAAA,MACrB;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,MAAqB;AACzB,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,WAAK,IAAI,OAAO,KAAK,MAAM,KAAK,MAAM,CAAC,QAAgB;AACrD,YAAI,IAAK,QAAO,GAAG;AACnB,cAAM,UAAU,KAAK,IAAI,QAAQ;AACjC,YAAI,OAAO,YAAa,UAAU;AAChC,eAAK,QAAQ,KAAK,+BAA+B,QAAS,IAAI,EAAE;AAAA,QAClE;AACA,gBAAQ;AAAA,MACV,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,QAAuB;AAC3B,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,WAAK,IAAI,MAAM,CAAC,QAAgB;AAC9B,YAAI,IAAK,QAAO,GAAG;AACnB,gBAAQ;AAAA,MACV,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AACF;","names":[]}