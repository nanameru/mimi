{"version":3,"sources":["../../src/llm/zod-utils.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport type { JSONSchema7 } from 'json-schema';\nimport { zodToJsonSchema as zodToJsonSchemaV3 } from 'zod-to-json-schema';\nimport type * as z3 from 'zod/v3';\nimport * as z4 from 'zod/v4';\n\n/**\n * Result type from Zod schema parsing.\n */\nexport type ZodParseResult<T = unknown> =\n  | { success: true; data: T }\n  | { success: false; error: unknown };\n\n/**\n * Type definition for Zod schemas that works with both v3 and v4.\n * Uses a union type of both Zod v3 and v4 schema types.\n *\n * Adapted from Vercel AI SDK's zodSchema function signature.\n * Source: https://github.com/vercel/ai/blob/main/packages/provider-utils/src/schema.ts#L278-L281\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type ZodSchema = z4.core.$ZodType<any, any> | z3.Schema<any, z3.ZodTypeDef, any>;\n\n/**\n * Detects if a schema is a Zod v4 schema.\n * Zod v4 schemas have a `_zod` property that v3 schemas don't have.\n *\n * @param schema - The schema to check\n * @returns True if the schema is a Zod v4 schema\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any -- Required to match Zod v4's type signature\nexport function isZod4Schema(schema: ZodSchema): schema is z4.core.$ZodType<any, any> {\n  // https://zod.dev/library-authors?id=how-to-support-zod-3-and-zod-4-simultaneously\n  return '_zod' in schema;\n}\n\n/**\n * Checks if a value is a Zod schema (either v3 or v4).\n *\n * @param value - The value to check\n * @returns True if the value is a Zod schema\n */\nexport function isZodSchema(value: unknown): value is ZodSchema {\n  if (typeof value !== 'object' || value === null) {\n    return false;\n  }\n\n  // Check for v4 schema (_zod property)\n  if ('_zod' in value) {\n    return true;\n  }\n\n  // Check for v3 schema (_def property with typeName)\n  if ('_def' in value && typeof value._def === 'object' && value._def !== null) {\n    const def = value._def as Record<string, unknown>;\n    if ('typeName' in def) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n/**\n * Checks if a Zod schema is an object schema.\n *\n * @param schema - The schema to check\n * @returns True if the schema is an object schema\n */\nexport function isZodObjectSchema(schema: ZodSchema): boolean {\n  // Need to access internal Zod properties to check schema type\n  const schemaWithInternals = schema as {\n    _def?: { type?: string; typeName?: string };\n    _zod?: { traits?: Set<string> };\n  };\n\n  // Check for v4 schema first\n  if (isZod4Schema(schema)) {\n    // v4 uses _def.type and _zod.traits\n    return (\n      schemaWithInternals._def?.type === 'object' ||\n      schemaWithInternals._zod?.traits?.has('ZodObject') ||\n      false\n    );\n  }\n\n  // v3 uses _def.typeName\n  return schemaWithInternals._def?.typeName === 'ZodObject';\n}\n\n/**\n * Converts a Zod schema to JSON Schema format.\n * Handles both Zod v3 and v4 schemas automatically.\n *\n * Adapted from Vercel AI SDK's zod3Schema and zod4Schema functions.\n * Source: https://github.com/vercel/ai/blob/main/packages/provider-utils/src/schema.ts#L237-L269\n *\n * @param schema - The Zod schema to convert\n * @param isOpenai - Whether to use OpenAI-specific formatting (default: true)\n * @returns A JSON Schema representation of the Zod schema\n */\nexport function zodSchemaToJsonSchema(schema: ZodSchema, isOpenai: boolean = true): JSONSchema7 {\n  if (isZod4Schema(schema)) {\n    // Zod v4 has native toJSONSchema support\n    // Configuration adapted from Vercel AI SDK to support OpenAPI conversion for Google\n    // Source: https://github.com/vercel/ai/blob/main/packages/provider-utils/src/schema.ts#L255-L258\n    return z4.toJSONSchema(schema, {\n      target: 'draft-7',\n      io: 'output',\n      reused: 'inline', // Don't use references by default (to support openapi conversion for google)\n    }) as JSONSchema7;\n  } else {\n    // Zod v3 requires the zod-to-json-schema library\n    // Configuration adapted from Vercel AI SDK\n    // $refStrategy: 'none' is equivalent to v4's reused: 'inline'\n    return zodToJsonSchemaV3(schema, {\n      target: isOpenai ? 'openAi' : 'jsonSchema7',\n      $refStrategy: 'none', // Don't use references by default (to support openapi conversion for google)\n    }) as JSONSchema7;\n  }\n}\n\n/**\n * Parses a value against a Zod schema.\n * Handles both Zod v3 and v4 parse APIs automatically.\n *\n * @param schema - The Zod schema to parse against\n * @param value - The value to parse\n * @returns A promise that resolves to the parse result\n */\nexport async function parseZodSchema<T = unknown>(\n  schema: ZodSchema,\n  value: unknown,\n): Promise<ZodParseResult<T>> {\n  if (isZod4Schema(schema)) {\n    const result = await z4.safeParseAsync(schema, value);\n    return result as ZodParseResult<T>;\n  } else {\n    const result = await schema.safeParseAsync(value);\n    return result as ZodParseResult<T>;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA,gCAAqD;AAErD,SAAoB;AA2Bb,SAAS,aAAa,QAAyD;AAEpF,SAAO,UAAU;AACnB;AAQO,SAAS,YAAY,OAAoC;AAC9D,MAAI,OAAO,UAAU,YAAY,UAAU,MAAM;AAC/C,WAAO;AAAA,EACT;AAGA,MAAI,UAAU,OAAO;AACnB,WAAO;AAAA,EACT;AAGA,MAAI,UAAU,SAAS,OAAO,MAAM,SAAS,YAAY,MAAM,SAAS,MAAM;AAC5E,UAAM,MAAM,MAAM;AAClB,QAAI,cAAc,KAAK;AACrB,aAAO;AAAA,IACT;AAAA,EACF;AAEA,SAAO;AACT;AAQO,SAAS,kBAAkB,QAA4B;AAvE9D;AAyEE,QAAM,sBAAsB;AAM5B,MAAI,aAAa,MAAM,GAAG;AAExB,aACE,yBAAoB,SAApB,mBAA0B,UAAS,cACnC,+BAAoB,SAApB,mBAA0B,WAA1B,mBAAkC,IAAI,iBACtC;AAAA,EAEJ;AAGA,WAAO,yBAAoB,SAApB,mBAA0B,cAAa;AAChD;AAaO,SAAS,sBAAsB,QAAmB,WAAoB,MAAmB;AAC9F,MAAI,aAAa,MAAM,GAAG;AAIxB,WAAO,GAAG,aAAa,QAAQ;AAAA,MAC7B,QAAQ;AAAA,MACR,IAAI;AAAA,MACJ,QAAQ;AAAA;AAAA,IACV,CAAC;AAAA,EACH,OAAO;AAIL,eAAO,0BAAAA,iBAAkB,QAAQ;AAAA,MAC/B,QAAQ,WAAW,WAAW;AAAA,MAC9B,cAAc;AAAA;AAAA,IAChB,CAAC;AAAA,EACH;AACF;AAUA,eAAsB,eACpB,QACA,OAC4B;AAC5B,MAAI,aAAa,MAAM,GAAG;AACxB,UAAM,SAAS,MAAM,GAAG,eAAe,QAAQ,KAAK;AACpD,WAAO;AAAA,EACT,OAAO;AACL,UAAM,SAAS,MAAM,OAAO,eAAe,KAAK;AAChD,WAAO;AAAA,EACT;AACF;","names":["zodToJsonSchemaV3"]}