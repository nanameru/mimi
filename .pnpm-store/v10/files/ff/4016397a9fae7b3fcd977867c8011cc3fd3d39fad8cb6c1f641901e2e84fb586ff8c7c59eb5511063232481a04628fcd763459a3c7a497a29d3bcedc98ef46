{"version":3,"sources":["../src/audio.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { AudioFrame } from '@livekit/rtc-node';\nimport { log } from './log.js';\nimport type { AudioBuffer } from './utils.js';\n\nexport function calculateAudioDurationSeconds(frame: AudioBuffer) {\n  // TODO(AJS-102): use frame.durationMs once available in rtc-node\n  return Array.isArray(frame)\n    ? frame.reduce((sum, a) => sum + a.samplesPerChannel / a.sampleRate, 0)\n    : frame.samplesPerChannel / frame.sampleRate;\n}\n\n/** AudioByteStream translates between LiveKit AudioFrame packets and raw byte data. */\nexport class AudioByteStream {\n  #sampleRate: number;\n  #numChannels: number;\n  #bytesPerFrame: number;\n  #buf: Int8Array;\n  #logger = log();\n\n  constructor(sampleRate: number, numChannels: number, samplesPerChannel: number | null = null) {\n    this.#sampleRate = sampleRate;\n    this.#numChannels = numChannels;\n\n    if (samplesPerChannel === null) {\n      samplesPerChannel = Math.floor(sampleRate / 10); // 100ms by default\n    }\n\n    this.#bytesPerFrame = numChannels * samplesPerChannel * 2; // 2 bytes per sample (Int16)\n    this.#buf = new Int8Array();\n  }\n\n  write(data: ArrayBuffer): AudioFrame[] {\n    this.#buf = new Int8Array([...this.#buf, ...new Int8Array(data)]);\n\n    const frames: AudioFrame[] = [];\n    while (this.#buf.length >= this.#bytesPerFrame) {\n      const frameData = this.#buf.slice(0, this.#bytesPerFrame);\n      this.#buf = this.#buf.slice(this.#bytesPerFrame);\n\n      frames.push(\n        new AudioFrame(\n          new Int16Array(frameData.buffer),\n          this.#sampleRate,\n          this.#numChannels,\n          frameData.length / 2,\n        ),\n      );\n    }\n\n    return frames;\n  }\n\n  flush(): AudioFrame[] {\n    if (this.#buf.length % (2 * this.#numChannels) !== 0) {\n      this.#logger.warn('AudioByteStream: incomplete frame during flush, dropping');\n      return [];\n    }\n\n    const frames = [\n      new AudioFrame(\n        new Int16Array(this.#buf.buffer),\n        this.#sampleRate,\n        this.#numChannels,\n        this.#buf.length / 2,\n      ),\n    ];\n\n    this.#buf = new Int8Array(); // Clear buffer after flushing\n    return frames;\n  }\n}\n"],"mappings":"AAGA,SAAS,kBAAkB;AAC3B,SAAS,WAAW;AAGb,SAAS,8BAA8B,OAAoB;AAEhE,SAAO,MAAM,QAAQ,KAAK,IACtB,MAAM,OAAO,CAAC,KAAK,MAAM,MAAM,EAAE,oBAAoB,EAAE,YAAY,CAAC,IACpE,MAAM,oBAAoB,MAAM;AACtC;AAGO,MAAM,gBAAgB;AAAA,EAC3B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,UAAU,IAAI;AAAA,EAEd,YAAY,YAAoB,aAAqB,oBAAmC,MAAM;AAC5F,SAAK,cAAc;AACnB,SAAK,eAAe;AAEpB,QAAI,sBAAsB,MAAM;AAC9B,0BAAoB,KAAK,MAAM,aAAa,EAAE;AAAA,IAChD;AAEA,SAAK,iBAAiB,cAAc,oBAAoB;AACxD,SAAK,OAAO,IAAI,UAAU;AAAA,EAC5B;AAAA,EAEA,MAAM,MAAiC;AACrC,SAAK,OAAO,IAAI,UAAU,CAAC,GAAG,KAAK,MAAM,GAAG,IAAI,UAAU,IAAI,CAAC,CAAC;AAEhE,UAAM,SAAuB,CAAC;AAC9B,WAAO,KAAK,KAAK,UAAU,KAAK,gBAAgB;AAC9C,YAAM,YAAY,KAAK,KAAK,MAAM,GAAG,KAAK,cAAc;AACxD,WAAK,OAAO,KAAK,KAAK,MAAM,KAAK,cAAc;AAE/C,aAAO;AAAA,QACL,IAAI;AAAA,UACF,IAAI,WAAW,UAAU,MAAM;AAAA,UAC/B,KAAK;AAAA,UACL,KAAK;AAAA,UACL,UAAU,SAAS;AAAA,QACrB;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,QAAsB;AACpB,QAAI,KAAK,KAAK,UAAU,IAAI,KAAK,kBAAkB,GAAG;AACpD,WAAK,QAAQ,KAAK,0DAA0D;AAC5E,aAAO,CAAC;AAAA,IACV;AAEA,UAAM,SAAS;AAAA,MACb,IAAI;AAAA,QACF,IAAI,WAAW,KAAK,KAAK,MAAM;AAAA,QAC/B,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK,KAAK,SAAS;AAAA,MACrB;AAAA,IACF;AAEA,SAAK,OAAO,IAAI,UAAU;AAC1B,WAAO;AAAA,EACT;AACF;","names":[]}